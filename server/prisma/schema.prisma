generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String     @id @default(uuid())
  username          String     @unique
  passwordHash      String     @map("password_hash")
  createdAt         DateTime   @default(now()) @map("created_at")
  active            Boolean    @default(true)
  companyId         String?    @map("company_id")
  role              UserRole   @default(OWNER)
  email             String     @unique
  lastLoginAt       DateTime?  @map("last_login_at")
  source            String?
  resetToken        String?    @map("reset_token")
  resetTokenExpires DateTime?  @map("reset_token_expires")
  auditLogs         AuditLog[]
  projects          Project[]
  company           Company?   @relation(fields: [companyId], references: [id])

  adminSessions  AdminSupportSession[] @relation("admin_sessions")
  targetSessions AdminSupportSession[] @relation("target_sessions")
  adminLogs      SupportAccessLog[]    @relation("admin_logs")
  targetLogs     SupportAccessLog[]    @relation("target_logs")

  engagementMetrics    UserEngagementMetrics?
  financialMetrics     UserFinancialMetrics?
  retentionAlerts      RetentionAlert[]
  retentionMessageLogs RetentionMessageLog[]

  @@index([companyId])
  @@map("users")
}

model Company {
  id                        String            @id @default(uuid())
  name                      String
  createdAt                 DateTime          @default(now()) @map("created_at")
  updatedAt                 DateTime          @default(now()) @updatedAt @map("updated_at")
  planId                    String?           @map("plan_id")
  subscriptionExpiresAt     DateTime?         @map("subscription_expires_at")
  status                    String            @default("ACTIVE")
  mercadopagoSubscriptionId String?           @map("mercadopago_subscription_id")
  phone                     String?
  address                   String?
  businessEmail             String?           @map("business_email")
  city                      String?
  cnpj                      String?
  logoUrl                   String?           @map("logo_url")
  state                     String?
  website                   String?
  zipCode                   String?           @map("zip_code")
  cables                    Cable[]
  catalogBoxes              CatalogBox[]
  catalogCables             CatalogCable[]
  catalogFusions            CatalogFusion[]
  catalogOLTs               CatalogOLT[]
  catalogPoles              CatalogPole[]
  catalogSplitters          CatalogSplitter[]
  plan                      Plan?             @relation(fields: [planId], references: [id])
  ctos                      Cto[]
  poles                     Pole[]
  pops                      Pop[]
  projects                  Project[]
  users                     User[]
  customers                 Customer[]

  engagementMetrics UserEngagementMetrics[]
  financialMetrics  UserFinancialMetrics[]
  retentionAlerts   RetentionAlert[]

  @@map("companies")
}

model Plan {
  id                String    @id @default(uuid())
  name              String
  price             Float     @default(0.0)
  limits            Json      @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at")
  features          Json      @default("[]")
  isRecommended     Boolean   @default(false)
  trialDurationDays Int?      @map("trial_duration_days")
  type              String    @default("STANDARD")
  priceYearly       Float?    @map("price_yearly")
  active            Boolean   @default(true)
  description       String?
  mercadopagoId     String?   @map("mercadopago_id")
  stripeId          String?   @map("stripe_id")
  companies         Company[]

  @@map("plans")
}

model Project {
  id        String     @id @default(uuid())
  userId    String     @map("user_id")
  name      String
  centerLat Float      @map("center_lat")
  centerLng Float      @map("center_lng")
  zoom      Int        @default(15)
  settings  Json?      @default("{\"snapDistance\": 30}")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @default(now()) @updatedAt @map("updated_at")
  companyId String?    @map("company_id")
  cables    Cable[]
  ctos      Cto[]
  poles     Pole[]
  customers Customer[]
  pops      Pop[]
  company   Company?   @relation(fields: [companyId], references: [id])
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("projects")
}

model Cto {
  id                String          @id @default(uuid())
  projectId         String          @map("project_id")
  name              String
  status            EquipmentStatus @default(PLANNED)
  lat               Float
  lng               Float
  splitters         Json?           @default("[]")
  fusions           Json?           @default("[]")
  connections       Json?           @default("[]")
  inputCableIds     String[]        @default([]) @map("input_cable_ids")
  layout            Json?           @default("{}")
  clientCount       Int             @default(0) @map("client_count")
  companyId         String?         @map("company_id")
  catalogId         String?         @map("catalog_id")
  color             String?
  reserveLoopLength Float?          @map("reserve_loop_length")
  type              String?         @default("CTO")
  poleId            String?         @map("pole_id")
  company           Company?        @relation(fields: [companyId], references: [id])
  project           Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  customers         Customer[]
  drops             Drop[]

  @@index([companyId])
  @@index([lat, lng])
  @@map("ctos")
}

model Pop {
  id            String          @id @default(uuid())
  projectId     String          @map("project_id")
  name          String
  status        EquipmentStatus @default(PLANNED)
  lat           Float
  lng           Float
  olts          Json?           @default("[]")
  dios          Json?           @default("[]")
  fusions       Json?           @default("[]")
  connections   Json?           @default("[]")
  inputCableIds String[]        @default([]) @map("input_cable_ids")
  layout        Json?           @default("{}")
  color         String?         @default("#6366f1")
  companyId     String?         @map("company_id")
  size          Int?            @default(24)
  poleId        String?         @map("pole_id")
  company       Company?        @relation(fields: [companyId], references: [id])
  project       Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([lat, lng])
  @@map("pops")
}

model Cable {
  id               String   @id @default(uuid())
  projectId        String   @map("project_id")
  name             String
  status           String?  @default("DEPLOYED")
  fiberCount       Int      @map("fiber_count")
  looseTubeCount   Int?     @default(1) @map("loose_tube_count")
  color            String?  @default("#0ea5e9")
  coordinates      Json
  fromNodeId       String?  @map("from_node_id")
  toNodeId         String?  @map("to_node_id")
  companyId        String?  @map("company_id")
  catalogId        String?  @map("catalog_id")
  colorStandard    String?  @default("ABNT") @map("color_standard")
  reserveLocation  Json?    @map("reserve_location")
  showReserveLabel Boolean  @default(true) @map("show_reserve_label")
  technicalReserve Float?   @default(0) @map("technical_reserve")
  company          Company? @relation(fields: [companyId], references: [id])
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("cables")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String   @default("SYSTEM")
  entityId  String   @default("") @map("entity_id")
  details   Json?    @default("{}")
  userId    String?  @map("user_id")
  companyId String?  @map("company_id")
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")
  user      User?    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@map("audit_logs")
}

model CatalogSplitter {
  id                     String   @id @default(uuid())
  name                   String
  type                   String
  mode                   String
  inputs                 Int      @default(1)
  outputs                Int
  connectorType          String?  @default("Unconnectorized") @map("connector_type")
  allowCustomConnections Boolean  @default(true) @map("allow_custom_connections")
  attenuation            Json?    @default("{}")
  description            String?
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @default(now()) @updatedAt @map("updated_at")
  companyId              String?  @map("company_id")
  company                Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("catalog_splitters")
}

model TemplateSplitter {
  id          String   @id @default(uuid())
  name        String
  type        String
  mode        String
  inputs      Int      @default(1)
  outputs     Int
  attenuation Json?    @default("{}")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("template_splitters")
}

model CatalogCable {
  id             String   @id @default(uuid())
  name           String
  brand          String?
  model          String?
  defaultLevel   String?
  fiberCount     Int
  looseTubeCount Int
  fibersPerTube  Int
  attenuation    Float?
  fiberProfile   String?
  description    String?
  deployedSpec   Json?    @default("{\"color\": \"#10b981\", \"width\": 3}")
  plannedSpec    Json?    @default("{\"color\": \"#86efac\", \"width\": 3}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")
  companyId      String?  @map("company_id")
  company        Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("catalog_cables")
}

model TemplateCable {
  id             String   @id @default(uuid())
  name           String
  brand          String?
  model          String?
  defaultLevel   String?
  fiberCount     Int
  looseTubeCount Int
  fibersPerTube  Int
  attenuation    Float?
  fiberProfile   String?
  description    String?
  deployedSpec   Json?    @default("{\"color\": \"#10b981\", \"width\": 3}")
  plannedSpec    Json?    @default("{\"color\": \"#86efac\", \"width\": 3}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("template_cables")
}

model CatalogBox {
  id                String   @id @default(uuid())
  name              String
  brand             String?
  model             String?
  type              String
  reserveLoopLength Float?
  color             String?  @default("#64748b")
  description       String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
  companyId         String?  @map("company_id")
  company           Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("catalog_boxes")
}

model TemplateBox {
  id                String   @id @default(uuid())
  name              String
  brand             String?
  model             String?
  type              String
  reserveLoopLength Float?
  color             String?  @default("#64748b")
  description       String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("template_boxes")
}

model CatalogPole {
  id          String   @id @default(uuid())
  name        String
  type        String
  height      Float
  strength    Float
  shape       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])
  instances   Pole[]

  @@index([companyId])
  @@map("catalog_poles")
}

model TemplatePole {
  id          String   @id @default(uuid())
  name        String
  type        String
  height      Float
  strength    Float
  shape       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("template_poles")
}

model Pole {
  id             String          @id @default(uuid())
  projectId      String          @map("project_id")
  name           String
  status         EquipmentStatus @default(PLANNED)
  lat            Float
  lng            Float
  catalogId      String?         @map("catalog_id")
  companyId      String?         @map("company_id")
  height         Float?
  linkedCableIds String[]        @default([]) @map("linked_cable_ids")
  type           String?
  catalog        CatalogPole?    @relation(fields: [catalogId], references: [id])
  company        Company?        @relation(fields: [companyId], references: [id])
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([lat, lng])
  @@map("poles")
}

model CatalogFusion {
  id          String   @id @default(uuid())
  name        String
  attenuation Float    @default(0.0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("catalog_fusions")
}

model TemplateFusion {
  id          String   @id @default(uuid())
  name        String
  attenuation Float    @default(0.0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("template_fusions")
}

model CatalogOLT {
  id           String   @id @default(uuid())
  name         String
  outputPower  Float    @default(3.0) @map("output_power")
  slots        Int      @default(1)
  portsPerSlot Int      @default(16) @map("ports_per_slot")
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")
  companyId    String?  @map("company_id")
  type         String   @default("OLT")
  company      Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@map("catalog_olts")
}

model TemplateOLT {
  id           String   @id @default(uuid())
  name         String
  outputPower  Float    @default(3.0) @map("output_power")
  slots        Int      @default(1)
  portsPerSlot Int      @default(16) @map("ports_per_slot")
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")
  type         String   @default("OLT")

  @@map("template_olts")
}

model DemoVideo {
  id          String   @id @default(uuid())
  title       String
  description String?
  url         String
  icon        String   @default("Monitor")
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("demo_videos")
}

model SmtpConfig {
  id        String   @id @default("global") @map("id")
  host      String
  port      Int
  user      String
  pass      String
  secure    Boolean  @default(true)
  fromEmail String   @map("from_email")
  fromName  String   @map("from_name")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("smtp_configs")
}

model EmailTemplate {
  id        String   @id @default(uuid())
  slug      String   @unique
  name      String
  subject   String
  body      String
  variables Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("email_templates")
}

model SaaSConfig {
  id              String   @id @default("global") @map("id")
  appName         String   @default("FTTH Planner") @map("app_name")
  appLogoUrl      String?  @map("app_logo_url")
  faviconUrl      String?  @map("favicon_url")
  supportEmail    String?  @map("support_email")
  supportPhone    String?  @map("support_phone")
  websiteUrl      String?  @map("website_url")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")
  appDescription  String?  @map("app_description")
  appKeywords     String?  @map("app_keywords")
  copyrightText   String?  @map("copyright_text")
  ctaBgImageUrl   String?  @map("cta_bg_image_url")
  footerDesc      String?  @map("footer_desc")
  heroPreviewUrl  String?  @map("hero_preview_url")
  ogImageUrl      String?  @map("og_image_url")
  socialFacebook  String?  @map("social_facebook")
  socialInstagram String?  @map("social_instagram")
  socialLinkedin  String?  @map("social_linkedin")
  socialTwitter   String?  @map("social_twitter")
  socialYoutube   String?  @map("social_youtube")

  @@map("saas_configs")
}

enum EquipmentStatus {
  PLANNED
  NOT_DEPLOYED
  DEPLOYED
  CERTIFIED
  ANALYSING
  LICENSED

  @@map("equipment_status")
}

enum UserRole {
  OWNER
  ADMIN
  MEMBER
  SUPER_ADMIN

  @@map("user_roles")
}

model Customer {
  id                String   @id @default(uuid())
  name              String
  document          String?
  phone             String?
  email             String?
  address           String?
  lat               Float
  lng               Float
  ctoId             String?  @map("cto_id")
  splitterId        String?  @map("splitter_id")
  splitterPortIndex Int?     @map("splitter_port_index")
  fiberId           String?  @map("fiber_id")
  status            String   @default("ACTIVE")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
  companyId         String?  @map("company_id")
  onuSerial         String?  @map("onu_serial")
  onuMac            String?  @map("onu_mac")
  pppoeService      String?  @map("pppoe_service")
  onuPower          Float?   @map("onu_power")
  projectId         String?  @map("project_id")

  cto     Cto?     @relation(fields: [ctoId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])
  drop    Drop?

  @@index([companyId])
  @@index([ctoId])
  @@map("customers")
}

model Drop {
  id          String   @id @default(uuid())
  customerId  String   @unique @map("customer_id")
  ctoId       String   @map("cto_id")
  coordinates Json // Stores the path geometry [{lat, lng}, ...]
  length      Float?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  cto      Cto      @relation(fields: [ctoId], references: [id])

  @@index([ctoId])
  @@map("drops")
}

model AdminSupportSession {
  id           String    @id @default(uuid())
  adminId      String    @map("admin_id")
  targetUserId String    @map("target_user_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  expiresAt    DateTime  @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")

  admin      User @relation("admin_sessions", fields: [adminId], references: [id])
  targetUser User @relation("target_sessions", fields: [targetUserId], references: [id])

  @@map("admin_support_sessions")
}

model SupportAccessLog {
  id           String   @id @default(uuid())
  adminId      String   @map("admin_id")
  targetUserId String   @map("target_user_id")
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  timestamp    DateTime @default(now())
  ipAddress    String?  @map("ip_address")

  admin      User @relation("admin_logs", fields: [adminId], references: [id])
  targetUser User @relation("target_logs", fields: [targetUserId], references: [id])

  @@map("support_access_logs")
}

model UserEngagementMetrics {
  id                   String    @id @default(uuid())
  userId               String    @unique @map("user_id")
  companyId            String?   @map("company_id")
  lastLoginAt          DateTime? @map("last_login_at")
  lastProjectCreatedAt DateTime? @map("last_project_created_at")
  login7d              Int       @default(0)
  login30d             Int       @default(0)
  actions7d            Int       @default(0)
  engagementScore      Float     @default(0)
  churnRiskScore       Float     @default(0) @map("churn_risk_score")
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([lastLoginAt])
  @@index([churnRiskScore])
  @@map("user_engagement_metrics")
}

model RetentionAlert {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  companyId  String?   @map("company_id")
  type       String
  severity   String    @default("medium")
  resolvedAt DateTime? @map("resolved_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@map("retention_alerts")
}

model RetentionAutomationRule {
  id              String   @id @default(uuid())
  triggerType     String   @map("trigger_type")
  delayInDays     Int      @default(0) @map("delay_in_days")
  messageTemplate String   @map("message_template")
  channel         String   @default("email")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  logs RetentionMessageLog[]

  @@map("retention_automation_rules")
}

model RetentionMessageLog {
  id      String   @id @default(uuid())
  userId  String   @map("user_id")
  ruleId  String   @map("rule_id")
  channel String
  status  String   @default("sent")
  sentAt  DateTime @default(now()) @map("sent_at")

  user User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  rule RetentionAutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ruleId])
  @@map("retention_message_logs")
}

model UserFinancialMetrics {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  companyId        String?  @map("company_id")
  monthlyRevenue   Float    @default(0) @map("monthly_revenue")
  lifetimeRevenue  Float    @default(0) @map("lifetime_revenue")
  estimatedLTV     Float    @default(0) @map("estimated_ltv")
  churnProbability Float    @default(0) @map("churn_probability")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@map("user_financial_metrics")
}
